# План интеграции escrow-lib в buy-to-earn

## 1. Обзор

Цель: Интегрировать функциональность библиотеки `escrow-lib` в проект `buy-to-earn` для управления эскроу-счетами, заказами и связанными процессами.

Ключевое решение: Создание промежуточного бэкенд-сервиса (далее "Escrow Backend"), который будет использовать `escrow-lib` и предоставлять API для фронтенд-приложения `buy-to-earn`.

## 2. Разработка Escrow Backend

### 2.1. Инициализация проекта
    - Создать новый Node.js проект (например, с использованием Express или NestJS).
    - Настроить TypeScript.

### 2.2. Интеграция `escrow-lib`
    - Добавить `escrow-lib` как зависимость (через `npm link` для локальной разработки или включение исходного кода/скомпилированных файлов).
    - Инициализировать `EscrowManager` при старте бэкенд-сервиса.

### 2.3. Замена In-Memory Storage
    - Выбрать и настроить базу данных (например, PostgreSQL).
    - Модифицировать сервисы `escrow-lib` (`UserService`, `OrderService`, `DocumentService`, `CommentService`) для работы с выбранной БД вместо in-memory хранилища. Это может потребовать:
        - Создания интерфейсов репозиториев.
        - Реализации этих интерфейсов для конкретной БД.
        - Внедрения репозиториев в сервисы `escrow-lib`.
    - Обновить документацию `escrow-lib` по части хранения данных.

### 2.4. Конфигурация
    - Настроить подключение к БД.
    - Настроить AI-провайдера (Gemini или Mock), включая безопасное хранение API-ключей (если используется Gemini), например, через переменные окружения.

### 2.5. Разработка API
    - Определить RESTful API эндпоинты для взаимодействия с фронтендом. Примеры эндпоинтов:
        - `POST /users` (создание пользователя)
        - `GET /users/:id` (получение информации о пользователе)
        - `POST /orders` (создание заказа)
        - `POST /group-orders` (создание группового заказа)
        - `GET /orders/:id` (получение информации о заказе)
        - `POST /orders/:id/fund` (внесение средств)
        - `POST /orders/:id/assign` (назначение исполнителя)
        - `POST /orders/:id/vote` (голосование за представителя в групповом заказе)
        - `GET /orders/:id/comments` (получение комментариев)
        - `POST /orders/:id/comments` (добавление комментария)
        - `POST /documents` (создание/загрузка документа)
        - `POST /documents/generate/:type` (генерация AI документа - DoR, Roadmap, DoD)
        - `POST /documents/validate` (валидация Deliverable)
        - `POST /acts` (генерация акта)
        - `POST /acts/:id/sign` (подписание акта)
        - `POST /acts/:id/reject` (отклонение акта)
    - Реализовать контроллеры и сервисы в бэкенде, которые будут вызывать соответствующие методы `EscrowManager` из `escrow-lib`.
    - Реализовать обработку ошибок и возврат соответствующих HTTP статусов.

### 2.6. Real-time Обновления (События)
    - Настроить WebSocket сервер (например, с использованием Socket.IO).
    - Подписаться на события `EscrowEvents` от `EscrowManager` в бэкенде.
    - При получении события от `escrow-lib`, транслировать его соответствующим клиентам (`buy-to-earn`) через WebSocket для обновления UI в реальном времени.

### 2.7. Аутентификация и Авторизация
    - Реализовать механизм аутентификации для API ( JWT).
    - Реализовать проверку прав доступа к эндпоинтам на основе роли пользователя и его связи с конкретным заказом/документом.

## 3. Интеграция с `buy-to-earn` (Фронтенд)

### 3.1. Взаимодействие с API
    - Модифицировать JavaScript код (`js/` директория) для отправки запросов к API Escrow Backend вместо текущей логики (если она есть).
    - Использовать `fetch` или библиотеки типа `axios` для API вызовов.
    - Обрабатывать ответы и ошибки от бэкенда.

### 3.2. Обработка Real-time Событий
    - Интегрировать WebSocket клиент (например, Socket.IO client).
    - Установить соединение с Escrow Backend.
    - Реализовать обработчики для событий, получаемых по WebSocket (например, `ORDER_FUNDED`, `ACT_SIGNED`, `MILESTONE_PAID`).
    - Обновлять соответствующие части UI динамически при получении событий.

### 3.3. Обновление UI
    - Разработать или модифицировать HTML (`*.html`) и CSS (`styles/`, `css/`) для отображения информации об эскроу-статусах, документах, вехах, комментариях.
    - Добавить элементы управления для выполнения действий, связанных с эскроу (например, кнопки "Внести средства", "Подписать акт", "Добавить комментарий").

### 3.4. Интеграция с системой аутентификации `buy-to-earn`
    - При логине пользователя в `buy-to-earn` получать токен аутентификации (например, JWT) от основной системы аутентификации (если она отдельная) или от Escrow Backend.
    - Передавать токен при каждом запросе к Escrow Backend API.

## 4. Управление Пользователями

- Необходимо сопоставить пользователей из системы `buy-to-earn` с пользователями `escrow-lib`.
- При регистрации/логине пользователя в `buy-to-earn`, соответствующий пользователь должен быть создан или получен в Escrow Backend через API (используя `escrow-lib`).
- ID пользователя из `buy-to-earn` должен использоваться при вызовах API Escrow Backend для идентификации автора действия.

## 5. Тестирование

- **Escrow Backend:**
    - Юнит-тесты для контроллеров, сервисов и логики взаимодействия с `escrow-lib`.
    - Юнит-тесты для слоя работы с БД (репозиториев).
    - Интеграционные тесты для API эндпоинтов.
- **`escrow-lib`:**
    - Добавить юнит-тесты для модифицированных частей (например, слой работы с БД), если они не покрыты существующими тестами.
- **`buy-to-earn` (Фронтенд):**
    - Юнит-тесты для новых/модифицированных JS-компонентов, отвечающих за взаимодействие с API и WebSocket.
    - E2E тесты для проверки пользовательских сценариев, включающих эскроу-функциональность.

## 6. Документация

- Создать документацию для API Escrow Backend (например, используя Swagger/OpenAPI).
- Обновить документацию `buy-to-earn`, описывающую новую функциональность эскроу.
- Обновить документацию `escrow-lib`, отражающую изменения (в частности, интеграцию с БД).

## 7. Возможное Расширение (Учет в архитектуре)

При проектировании Escrow Backend и API следует учитывать возможные будущие требования:

- **Объединение похожих заказов:**
    - Бэкенд может предоставлять API для поиска похожих заказов по заданным критериям (описание, тип работ, бюджет и т.д.), используя данные из `escrow-lib`.
    - Логика объединения (например, создание нового группового заказа и перенос средств/участников) должна быть реализована в Escrow Backend.
- **Поиск готовых решений:**
    - Аналогично объединению, бэкенд может реализовывать поиск по завершенным заказам или документам (например, спецификациям) для повторного использования.
- **Расширение `escrow-lib`:**
    - Если потребуется новая функциональность в самой библиотеке (например, поддержка нового типа документа, изменение логики голосования), изменения должны вноситься в `escrow-lib` с соблюдением стандартов разработки (юнит-тесты, документация) и затем обновляться в Escrow Backend.

## 8. Развертывание

- Настроить CI/CD пайплайны для Escrow Backend и `buy-to-earn`.
- Подготовить скрипты миграции для базы данных Escrow Backend.
- Обеспечить мониторинг и логирование для Escrow Backend.
