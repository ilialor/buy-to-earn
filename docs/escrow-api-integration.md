# Интеграция с Escrow API

## Общая информация

**Бэкенд API:**
- URL: `https://escrow-ocezgvm46-avas-projects-1e47760b.vercel.app/api`
- API-ключ: `Escrow-secret-test-1`

## Структура интеграции

### Модули API

API-интеграция реализована через модульную структуру в директории `js/api/`:

1. **escrow-client.js** - Базовый клиент для работы с API
   - Класс `EscrowClient` реализует все низкоуровневые запросы к API
   - Обработка ошибок и аутентификация через API-ключ

2. **escrow-api.js** - Инициализация клиента
   - Создание экземпляра API-клиента с конфигурацией для текущей среды

3. **user-service.js** - Сервис для работы с пользователями
   - Регистрация пользователей в системе Escrow
   - Получение информации о пользователе
   - Маппинг ролей пользователей между локальной системой и Escrow API

4. **order-service.js** - Сервис для работы с заказами
   - Создание заказов
   - Финансирование заказов
   - Получение списка заказов пользователя

5. **milestone-service.js** - Сервис для работы с этапами заказов
   - Отметка этапа как выполненного
   - Подписание актов выполненных работ
   - Работа со статусами этапов

6. **ui-utils.js** - Утилиты интерфейса
   - Показ/скрытие индикатора загрузки
   - Отображение уведомлений и ошибок

7. **storage-sync.js** - Синхронизация с локальным хранилищем
   - Конвертация данных между API и локальным форматом
   - Обеспечение обратной совместимости с существующей системой

8. **payment-wrapper.js** - Обертка для платежной системы
   - Интеграция с существующими платежными механизмами
   - Обработка событий оплаты

9. **index.js** - Основная точка входа
   - Экспорт всех сервисов API для использования в приложении
   - Инициализация при загрузке страницы

## Использование в коде

```javascript
// Регистрация пользователя в Escrow
window.escrowAPI.userService.registerUserWithEscrow(user);

// Создание заказа
window.escrowAPI.orderService.createOrder(orderData);

// Финансирование заказа
window.escrowAPI.orderService.fundOrder(orderId, fundData);

// Завершение этапа
window.escrowAPI.milestoneService.completeMilestone(orderId, milestoneId);

// Подписание акта
window.escrowAPI.milestoneService.signAct(orderId, milestoneId);
```

## Изменения в существующем коде

Следующие файлы были модифицированы для поддержки интеграции:

1. **index.html** - Добавлен скрипт для загрузки API-модуля
2. **js/auth.js** - Добавлена синхронизация с Escrow API при аутентификации
3. **js/escrow/ui.js** - Обновлены методы для работы с Escrow API вместо локального хранилища
4. **js/escrow/index.js** - Добавлена инициализация API и обработка событий аутентификации

## Обратная совместимость

Реализация сохраняет обратную совместимость с предыдущей системой:
- Все изменения нетвердые
- Данные синхронизируются между API и локальным хранилищем
- Если API недоступен, приложение будет работать с локальной реализацией

## Безопасность

- API-ключ хранится в конфигурационном файле и передается с каждым запросом
- Пользовательские данные синхронизируются через безопасные соединения (HTTPS)
- Ошибки API обрабатываются и не вызывают падения приложения
