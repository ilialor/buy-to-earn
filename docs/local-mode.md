# Локальный режим работы Buy-to-Earn

## Обзор локального режима

Локальный режим работы позволяет использовать основные функции платформы Buy-to-Earn без подключения к Firebase. Данные сохраняются в localStorage браузера, что делает возможным тестирование функционала на локальном компьютере.

## Реализованные функции в локальном режиме

### Аутентификация
- Локальная авторизация и регистрация пользователей
- Тестовый пользователь создается автоматически
- Данные пользователей хранятся в localStorage
- Работает с разными браузерами и сеансами

### База данных
- Локальное сохранение документов в коллекциях
- Возможность добавления новых записей
- Автоматическое переключение между Firebase и localStorage
- Сохранение документов при отсутствии подключения к Firebase

### Функциональность заказов
- Создание заказов в локальном режиме
- Отображение и загрузка заказов из localStorage
- Сохранение истории транзакций
- Работа без подключения к интернету
- Раздел "Твои заказы" для просмотра созданных пользователем заказов
- Мгновенное отображение созданных заказов без ожидания перезагрузки

### Многоязычный интерфейс
- Полная поддержка русского языка во всех разделах включая Поддержку
- Автоматическое переключение между языками
- Правильное отображение всех элементов интерфейса на выбранном языке

## Исправленные ошибки

### Ошибка при создании заказа

**Описание ошибки:**
```
db.js:288 Error creating order: TypeError: Cannot read properties of null (reading 'currentUser')
    at createOrder (db.js:261:23)
    at HTMLFormElement.<anonymous> (ui.js:561:9)
```

**Причина:**
Функция `createOrder` пыталась обратиться к объекту `auth.currentUser`, который мог быть `null` даже при локальной авторизации, когда информация о пользователе хранится только в localStorage.

**Решение:**
1. В функции `createOrder` в `db.js` уже была реализована проверка как Firebase Auth, так и localStorage:
   - Проверка существования `window.auth` и `window.auth.currentUser`
   - Получение данных из localStorage при отсутствии Firebase Auth

2. Исправлен код в `ui.js` для корректной работы с любыми источниками аутентификации:
   - Удалена жесткая зависимость от `window.auth.currentUser`
   - Добавлена функция `getCurrentUser()` для унифицированного получения данных пользователя
   - Улучшена функция `isUserAuthenticated()` для надежной проверки авторизации

3. Данные пользователя теперь не передаются из UI в функцию `createOrder`, а получаются внутри нее:
   - Функция самостоятельно определяет ID пользователя из Firebase или localStorage
   - Даже если UI не имеет доступа к пользовательским данным, заказ будет создан корректно

### Улучшения в механизме аутентификации

1. **Улучшенная функция проверки авторизации:**
   - Функция `isUserAuthenticated()` теперь проверяет как Firebase Auth, так и localStorage
   - Более надежная проверка наличия пользователя в локальном хранилище
   - Автоматическая инициализация локальной авторизации при необходимости

2. **Универсальная функция получения данных пользователя:**
   - Добавлена функция `getCurrentUser()` для получения данных пользователя из любого источника
   - Возвращает единый формат данных пользователя независимо от источника (Firebase или localStorage)
   - Включает флаг `isLocal` для определения типа авторизации

3. **Обработка индикаторов загрузки:**
   - Добавлены индикаторы состояния для кнопок при выполнении операций
   - Корректное восстановление состояния кнопок после завершения операций
   - Улучшенная обработка ошибок с информативными сообщениями

### Добавление раздела "Твои заказы"

**Проблема:**
Пользователь не видел свои созданные заказы в маркетплейсе, несмотря на успешное создание.

**Решение:**
1. Добавлен специальный раздел "Твои заказы" в маркетплейсе:
   - Заказы пользователя отображаются в отдельном блоке в верхней части списка
   - Визуальное отличие заказов пользователя (специальное оформление)
   - Отдельные заголовки для разделов "Твои заказы" и "Все активные заказы"

2. Улучшена функция `loadMarketplaceOrders()`:
   - Автоматическое определение заказов текущего пользователя
   - Фильтрация заказов по идентификатору пользователя
   - Предотвращение дублирования заказов пользователя в общем списке

3. Модифицирована функция `createOrderElement()`:
   - Разное оформление для заказов пользователя и других заказов
   - Разные кнопки действий ("Редактировать" вместо "Участвовать" для своих заказов)
   - Добавлен индикатор "Ваш заказ" для лучшей визуальной идентификации

4. Добавлены соответствующие стили:
   - Фоновое выделение для заказов пользователя
   - Специальные заголовки разделов
   - Визуальное разделение секций при помощи разделителей

5. **Мгновенное отображение созданных заказов:**
   - Заказ добавляется на страницу немедленно после создания, без ожидания ответа сервера
   - Созданный заказ добавляется в раздел "Твои заказы", даже если раздел ранее не существовал
   - После добавления происходит фоновое обновление всех заказов через `loadMarketplaceOrders()`

### Проблемы с добавлением документов

**Проблема:**
При отсутствии подключения к Firebase или при ошибках подключения не было возможности сохранять данные.

**Решение:**
1. Добавлен метод `addLocalDocument` для сохранения документов в localStorage
2. Реализовано автоматическое переключение между Firebase и localStorage
3. При ошибках сохранения в Firebase данные автоматически сохраняются локально
4. Генерация уникальных идентификаторов для локальных документов
5. **Улучшенная обработка ошибок:**
   - Вместо использования `console.error` для логирования ошибок Firebase используется `console.warn`
   - Предупреждения вместо ошибок позволяют не отвлекать пользователя от работы с приложением
   - Ошибки при создании заказа в UI также преобразованы в предупреждения

### Проблемы с получением заказов

**Проблема:**
При отсутствии подключения к Firebase невозможно было отобразить список заказов.

**Решение:**
1. Добавлен метод `getLocalOrders` для получения заказов из localStorage
2. Реализовано автоматическое переключение между Firebase и localStorage
3. Добавлена сортировка заказов по дате создания
4. Правильная обработка ошибок при получении заказов

### Проблемы с многоязычным интерфейсом

**Проблема:**
Раздел поддержки не переводился на русский язык при переключении интерфейса.

**Решение:**
1. Добавлены атрибуты `data-i18n` для всех текстовых элементов в разделе поддержки
2. Для FAQ вопросов и ответов добавлены новые ключи локализации
3. Все локализационные файлы (ru.js, en.js, es.js) обновлены с новыми ключами
4. Обеспечена корректная работа переводчика при загрузке страницы

## Использование локального режима

### Автоматическое переключение
Система автоматически определяет доступность Firebase и переключается в локальный режим при необходимости. Специальных действий не требуется.

### Тестовый пользователь
При первом запуске в локальном режиме создается тестовый пользователь:
- Email: test@example.com
- Пароль: password

### Просмотр созданных заказов
После создания заказа:
1. Заказ автоматически сохраняется в локальном хранилище или Firebase
2. Созданный заказ отображается в разделе "Твои заказы" на странице маркетплейса
3. Для каждого вашего заказа доступны кнопки "Редактировать" и "Детали"

### Очистка данных
Для очистки всех локальных данных:
1. Откройте инструменты разработчика (F12)
2. Перейдите во вкладку "Application" (Chrome) или "Storage" (Firefox)
3. Выберите "Local Storage" в левой панели
4. Удалите элементы, начинающиеся с "local_" и "localAuth_"

## Ограничения локального режима

1. **Отсутствие синхронизации:** данные хранятся только в текущем браузере и не синхронизируются между устройствами.
2. **Ограниченный объем:** localStorage имеет ограничение на объем хранимых данных (обычно 5-10 МБ).
3. **Нет серверной валидации:** все проверки выполняются только на клиенте.
4. **Отсутствие защиты данных:** данные могут быть изменены пользователем через инструменты разработчика.
5. **Ограниченная функциональность:** некоторые продвинутые функции доступны только при подключении к Firebase.

## Рекомендации по разработке

1. Тестируйте функциональность как в режиме Firebase, так и в локальном режиме
2. Используйте единый интерфейс для доступа к данным через методы в db.js
3. Добавляйте соответствующую обработку ошибок для обоих режимов
4. При разработке новых функций учитывайте возможность локального режима работы
5. Используйте функции `isUserAuthenticated()` и `getCurrentUser()` для надежной работы с пользовательскими данными
6. Используйте `console.warn` вместо `console.error` для некритичных ошибок
7. Добавляйте атрибуты `data-i18n` для всех текстовых элементов в HTML 